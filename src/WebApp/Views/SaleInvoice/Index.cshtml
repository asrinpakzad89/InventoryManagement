@model List<SaleInvoiceListDto>

@{
    ViewData["Title"] = "لیست فاکتورهای فروش";
    var customers = ViewBag.Customers;
    var products = ViewBag.Products;
}

<div class="container mt-4" style="direction:rtl;">

    <h2 class="mb-3"><strong>لیست فاکتورهای فروش</strong></h2>
    <hr />

    <div class="card">
        <div class="card-body">

            <div class="row">

                <div class="col-md-3">
                    <label>نام محصول</label>
                    <input id="ProductName" class="form-control" placeholder="مثلاً: استامینوفن" />
                </div>

                <div class="col-md-2">
                    <label>شماره فاکتور</label>
                    <input id="InvoiceNumber" class="form-control" placeholder="1234" />
                </div>

                <div class="col-md-3">
                    <label>مشتری</label>
                    <select id="CustomerId" class="form-control">
                        <option value="">همه</option>
                        @foreach (var c in customers)
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label>از تاریخ</label>
                    <input id="FromDate" type="date" class="form-control" />
                </div>

                <div class="col-md-2">
                    <label>تا تاریخ</label>
                    <input id="ToDate" type="date" class="form-control" />
                </div>

            </div>

            <button class="btn btn-primary btn-sm mt-3 w-100" onclick="searchInvoices()">جستجو</button>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-body">
            <table class="table table-striped table-bordered" id="invoiceTable">
                <thead>
                    <tr>
                        <th>شماره فاکتور</th>
                        <th>مشتری</th>
                        <th>تاریخ</th>
                        <th>جمع کل</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody id="invoiceBody">
                    @foreach (var inv in Model)
                    {
                        <tr>
                            <td>@inv.InvoiceNumber</td>
                            <td>@inv.CustomerName</td>
                            <td>@inv.Date.ToString("yyyy/MM/dd")</td>
                            <td>@String.Format("{0:N0}", inv.TotalPrice)</td>
                            <td>
                                <button class="btn btn-info btn-sm" onclick="showDetails(@inv.Id)">مشاهده</button>
                                <button class="btn btn-warning btn-sm" onclick="editInvoice(@inv.Id)">ویرایش</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>


<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content shadow-lg" style="border-radius:12px;">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">جزئیات فاکتور فروش</h5>
            </div>

            <div class="modal-body" style="background:#fafafa;">

                <div class="row text-center mb-4">
                    <div class="col-md-4">
                        <div class="p-3 bg-white shadow-sm rounded">
                            <strong>شماره فاکتور</strong>
                            <div class="fw-bold mt-1" id="mInvoiceNumber"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 bg-white shadow-sm rounded">
                            <strong>مشتری</strong>
                            <div class="fw-bold mt-1" id="mCustomer"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 bg-white shadow-sm rounded">
                            <strong>تاریخ</strong>
                            <div class="fw-bold mt-1" id="mDate"></div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-light fw-bold">
                        لیست آیتم‌ها
                    </div>

                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 text-center">
                            <thead class="table-secondary">
                                <tr>
                                    <th>ردیف</th>
                                    <th>محصول</th>
                                    <th>تعداد</th>
                                    <th>قیمت فروش</th>
                                    <th>جمع</th>
                                </tr>
                            </thead>
                            <tbody id="mItems"></tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-4 text-end">
                    <h5 class="d-inline-block ms-3">
                        جمع کل: <span id="mTotal" class="text-primary fw-bold"></span> تومان
                    </h5>
                </div>


            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
            </div>

        </div>
    </div>
</div>


<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">

            <div class="modal-header bg-warning">
                <h5 class="modal-title">ویرایش فاکتور فروش</h5>
            </div>

            <div class="modal-body">

                <input type="hidden" id="eId" />

                <div class="row">
                    <div class="col-md-4">
                        <label>شماره فاکتور</label>
                        <input id="eInvoiceNumber" class="form-control" disabled />
                    </div>

                    <div class="col-md-4">
                        <label>مشتری</label>
                        <select id="eCustomerId" class="form-control">
                            @foreach (var c in customers)
                            {
                                <option value="@c.Id">@c.Name</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label>تاریخ</label>
                        <input id="eDate" type="date" class="form-control" />
                    </div>
                </div>

                <hr />

                <h5>آیتم‌ها</h5>

                <table class="table table-bordered text-center" id="itemsTable">
                    <thead>
                        <tr>
                            <th>محصول</th>
                            <th>تعداد</th>
                            <th>قیمت فروش</th>
                            <th>عملیات</th>
                        </tr>
                    </thead>
                    <tbody id="eItems"></tbody>
                </table>

                <button class="btn btn-success" onclick="addItemRow()">افزودن آیتم</button>

            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveEdit()">ذخیره تغییرات</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
            </div>

        </div>
    </div>
</div>

@section Scripts {

    <script>

        function searchInvoices() {

            let data = {
                ProductName: $("#ProductName").val() || null,
                InvoiceNumber: $("#InvoiceNumber").val() || null,
                CustomerId: $("#CustomerId").val() ? parseInt($("#CustomerId").val()) : null,
                FromDate: $("#FromDate").val() ? new Date($("#FromDate").val()) : null,
                ToDate: $("#ToDate").val() ? new Date($("#ToDate").val()) : null
            };

             $.ajax({
                url: "/SaleInvoice/Search",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (res) {
                    $("#invoiceBody").html("");

                    res.forEach(inv => {
                        $("#invoiceBody").append(`
                            <tr>
                                <td>${inv.invoiceNumber}</td>
                                <td>${inv.customerName}</td>
                                <td>${inv.dateString}</td>
                                <td>${inv.totalPrice.toLocaleString()}</td>
                                <td>
                                    <button class="btn btn-info btn-sm" onclick="showDetails(${inv.id})">
                                        مشاهده
                                    </button>
                                </td>
                            </tr>
                        `)
                    });
                }
            });
        }

        function showDetails(id) {
            $.get(`/SaleInvoice/Details/${id}`, function (data) {
                $("#mInvoiceNumber").text(data.invoiceNumber);
                $("#mCustomer").text(data.customerName);
                $("#mDate").text(new Date(data.date).toLocaleDateString('fa-IR'));
                $("#mTotal").text(data.totalPrice.toLocaleString());

                let rows = "";
                let rowNum = 1;

                data.items.forEach(item => {
                    let lineTotal = item.quantity * item.salePrice;

                    rows += `
                        <tr>
                            <td>${rowNum++}</td>
                            <td>${item.productName}</td>
                            <td>${item.quantity}</td>
                            <td>${item.salePrice.toLocaleString()}</td>
                            <td>${lineTotal.toLocaleString()}</td>
                        </tr>
                    `;
                });

                $("#mItems").html(rows);

                new bootstrap.Modal(document.getElementById('invoiceModal')).show();
            }).fail(() => Swal.fire('خطا','خطا در دریافت جزئیات','error'));
        }

        function editInvoice(id) {

            $.get(`/SaleInvoice/Details/${id}`, function (data) {

                $("#eId").val(data.id);
                $("#eInvoiceNumber").val(data.invoiceNumber);
                $("#eCustomerId").val(data.customerId);

                let d = new Date(data.date);
                $("#eDate").val(d.toISOString().substring(0, 10));

                $("#eItems").html("");

                data.items.forEach(item => {

                    let maxQty = item.maxQuantity ?? item.quantity; 

                    let row = `
                        <tr>
                            <td>
                                <input class="form-control" value="${item.productName}" disabled />
                                <span hidden> ${item.productId}"</span>
                            </td>
                            <td>
                                <input type="number" class="form-control qtyInput" value="${item.quantity}" min="1" max="${maxQty}"
                                    oninput="validateEditQuantity(this)" />
                            </td>
                            <td>
                                <input type="number" class="form-control priceInput" value="${item.salePrice}" />
                            </td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="removeRow(this)">حذف</button>
                            </td>
                        </tr>
                    `;

                    $("#eItems").append(row);
                });

                new bootstrap.Modal("#editModal").show();
            });
        }

        // متد اعتبارسنجی تعداد محصول در ویرایش
        function validateEditQuantity(input) {
            let maxQty = parseInt($(input).attr("max")) || 1;
            let val = parseInt($(input).val());

            if (val > maxQty) {
                swal.fire('هشدار', `تعداد نمی‌تواند بیشتر از موجودی (${maxQty}) باشد!`, 'warning');
                $(input).val(maxQty);
            }
            if (val <= 0) $(input).val(1);
        }



        function removeRow(btn) {
            $(btn).closest("tr").remove();
        }


        function onProductChange(select) {

              let selected = $(select).find("option:selected");
            
              let qty = selected.data("qty");
              let price = selected.data("price");
              let productId = selected.val();
            
              let row = $(select).closest("tr");
            
              row.find(".qtyInput").attr("max", qty);
              row.find(".qtyInput").val(1);
              row.find(".priceInput").val(price);
            
              let td = $(select).closest("td");
            
              td.find(".product-id-span").remove();
              td.append(
                  `<span hidden>
                      ${productId}
                  </span>`
              );
        }

        function validateQuantity(input) {

            let row = $(input).closest("tr");
            let product = row.find(".productSelect option:selected");

            let maxQty = product.data("qty");

            if (!maxQty) {
                $(input).val(1);
                return;
            }

            let val = parseInt($(input).val());

            if (val > maxQty) {
                 swal.fire('هشدار', "تعداد بیشتر از موجودی است!", 'warning');
                $(input).val(maxQty);
            }

            if (val <= 0) $(input).val(1);
        }

        function addItemRow() {

           let products = @Html.Raw(Json.Serialize(products));

            let productOptions = '<option value="">انتخاب کنید...</option>';

            products.forEach(p => {
                 const disabled = p.quantity === 0 ? "disabled" : "";
                 const label = p.quantity === 0
                     ? `${p.name} (ناموجود)`
                     : `${p.name} (موجودی: ${p.quantity})`;

                 productOptions += `
                     <option value="${p.id}" data-qty="${p.quantity}" data-price="${p.sellingPrice}" ${disabled}>
                         ${label}
                     </option>`;
             });

            let row = `
                <tr>
                     <td>
                        <select class="form-control productSelect" onchange="onProductChange(this)">
                            ${productOptions}
                        </select>
                    </td>

                    <td>
                        <input type="number" class="form-control qtyInput" min="1" value="1"
                            oninput="validateQuantity(this)" />
                    </td>

                    <td>
                        <input type="number" class="form-control priceInput" min="0" />
                    </td>
                    <td><button class="btn btn-danger btn-sm" onclick="removeRow(this)">حذف</button></td>
                </tr>
            `;

            $("#eItems").append(row);
        }

        function setProductName(sel) {
            let productId = $(sel).val();
            let productName = $(sel).find("option:selected").text();

            $(sel).closest("td").find("input[type=hidden]").val(productId);
        }


        function saveEdit() {

            let id = $("#eId").val();
            let items = [];

            $("#eItems tr").each(function () {

                    let tds = $(this).find("td");
                   
                    let span = $(tds[0]).find("span");
                    let isOld = span.length > 0;

                    let productId = isOld
                        ? parseInt(span.text())
                        : parseInt($(tds[0]).find("select").val());
                   
                    let productName = isOld
                        ? $(tds[0]).find("input").val()
                        : $(tds[0]).find("select option:selected").text();


                    items.push({
                    productId: productId,
                    productName: productName,
                    quantity: parseFloat($(tds[1]).find("input").val()),
                    maxQuantity: parseFloat("0"),
                    salePrice: parseFloat($(tds[2]).find("input").val())
                });
            });

            let postData = {
                id: parseInt(id),
                invoiceNumber: $("#eInvoiceNumber").val(),
                customerId: $("#eCustomerId").val(),
                date: $("#eDate").val(),
                items: items
            };
            // alert(JSON.stringify(postData, null, 4));

            $.ajax({
                url: "/SaleInvoice/Edit",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(postData),
                success: function (data) {
                    if (data.isSuccess) {
                        swal.fire('موفق', data.message, 'success')
                            .then(() => location.reload());
                    }
                    else {
                        swal.fire('هشدار', data.message, 'warning');
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطای سرور',
                        text: 'مشکلی پیش آمد، دوباره تلاش کنید.',
                        confirmButtonText: 'باشه'
                    });
                }
            });
        }

    </script>

}
